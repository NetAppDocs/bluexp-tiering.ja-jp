---
sidebar: sidebar 
permalink: task-tiering-onprem-aws.html 
keywords: data tiering, fabricpool, cloud tiering, tiering cold data, tiering inactive data, tiering aff, tiering fas, tiering ontap, tiering volumes, tier data, tier cold data, tier fas, tier aff, tier ontap, aws, amazon, s3 
summary: アクセス頻度の低いデータを Amazon S3 に階層化することで、オンプレミスの ONTAP クラスタの空きスペースを確保します。 
---
= オンプレミスの ONTAP クラスタから Amazon S3 へデータを階層化する
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
アクセス頻度の低いデータを Amazon S3 に階層化することで、オンプレミスの ONTAP クラスタの空きスペースを確保します。



== クイックスタート

これらの手順を実行すると、すぐに作業を開始できます。各手順の詳細については、このトピックの以降のセクションを参照してください。

[role="quick-margin-para"]
オンプレミスのONTAP クラスタをパブリックインターネット経由でAWS S3に直接接続するか、VPNとAWS Direct Connectのどちらを使用してトラフィックをAWS S3にルーティングするかを選択します。

[role="quick-margin-para"]
 diagrams for connection options,使用可能な接続方法を参照してください。

[role="quick-margin-para"]
AWS VPCまたはオンプレミスにすでにコネクタが導入されている場合は、すべて設定されます。そうでない場合は、ONTAP データをAWS S3ストレージに階層化するためのコネクタを作成する必要があります。また、コネクタのネットワーク設定をカスタマイズして AWS S3 に接続できるようにする必要があります。

[role="quick-margin-para"]
 your Connector,コネクタの作成方法および必要なネットワーク設定の定義方法を参照してください。

[role="quick-margin-para"]
Cloud Manager で ONTAP クラスタを検出し、クラスタが最小要件を満たしていることを確認し、クラスタが AWS S3 に接続できるようにネットワーク設定をカスタマイズします。

[role="quick-margin-para"]
 your ONTAP cluster,オンプレミスの ONTAP クラスタを準備する方法をご確認ください。

[role="quick-margin-para"]
ConnectorでS3バケットの作成と管理を行うための権限を設定します。また、オンプレミスのONTAP クラスタに対する権限を設定して、S3バケットに対してデータの読み取りと書き込みを行えるようにする必要があります。

[role="quick-margin-para"]
 up S3 permissions,Connectorおよびオンプレミスクラスタの権限を設定する方法については、を参照してください。

[role="quick-margin-para"]
オンプレミスの作業環境を選択し、階層化サービスの「*有効化」をクリックして、プロンプトに従ってAmazon S3にデータを階層化します。

[role="quick-margin-para"]
 inactive data from your first cluster to Amazon S3,ボリュームの階層化を有効にする方法を参照してください。

[role="quick-margin-para"]
無償トライアルの終了後、従量課金制のサブスクリプション、 ONTAP Cloud Tiering のライセンス、またはその両方を組み合わせて使用したクラウド階層化の料金をお支払いください。

* AWS Marketplace でサブスクライブするには、 https://aws.amazon.com/marketplace/pp/prodview-oorxakq6lq7m4?sr=0-8&ref_=beagle&applicationId=AWSMPContessa["Cloud Manager Marketplace の製品に移動します"^]をクリックし、 * Subscribe * をクリックして、画面の指示に従います。
* Cloud Tiering BYOL ライセンスを使用して支払う場合は、 mailto:ng-cloud-tiering@netapp.com ？ subject=Licensing [ 購入が必要な場合はお問い合わせください ] のあとに link:task-licensing-cloud-tiering.html#add-cloud-tiering-byol-licenses-to-your-account["Cloud Manager Digital Wallet からアカウントに追加します"]。




== 接続オプションのネットワークダイアグラム

オンプレミスのONTAP システムからAWS S3への階層化を設定する場合、2つの接続方法を使用できます。

* パブリック接続 - パブリック S3 エンドポイントを使用して、 ONTAP システムを AWS S3 に直接接続します。
* プライベート接続 - VPN または AWS Direct Connect を使用して、プライベート IP アドレスを使用する VPC エンドポイントインターフェイス経由でトラフィックをルーティングします。


次の図は、*パブリック接続*メソッドと、コンポーネント間の準備に必要な接続を示しています。オンプレミスにインストールしたコネクタや、AWS VPCに導入したコネクタを使用できます。

image:diagram_cloud_tiering_aws_public.png["Cloud Tieringが、パブリック接続を介して、アクセス頻度の低いデータが配置されているクラスタ上のボリュームおよびAWS S3ストレージと通信する仕組みを示す図。"]

次の図は、*プライベート接続*メソッドと、コンポーネント間の準備に必要な接続を示しています。オンプレミスにインストールしたコネクタや、AWS VPCに導入したコネクタを使用できます。

image:diagram_cloud_tiering_aws_private.png["Cloud Tieringが、プライベート接続を介して、クラスタ上のボリューム、およびアクセス頻度の低いデータが配置されているAWS S3ストレージと通信する仕組みを示す図。"]


NOTE: コネクタと S3 の間の通信は、オブジェクトストレージのセットアップにのみ使用されます。



== コネクタを準備します

Cloud Manager Connector は、 Cloud Manager 機能のメインソフトウェアです。アクセス頻度の低いONTAP データを階層化するにはコネクタが必要です。



=== コネクタの作成または切り替え

AWS VPCまたはオンプレミスにすでにコネクタが導入されている場合は、すべて設定されます。ない場合は、ONTAP データをAWS S3ストレージに階層化するために、これらのどちらかの場所にコネクタを作成する必要があります。別のクラウドプロバイダに導入されているコネクタは使用できません。

* https://docs.netapp.com/us-en/cloud-manager-setup-admin/concept-connectors.html["コネクタについて説明します"^]
* https://docs.netapp.com/us-en/cloud-manager-setup-admin/reference-checklist-cm.html["コネクタの使用を開始する"^]
* https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-creating-connectors-aws.html["AWSにコネクタをインストールする"^]
* https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-installing-linux.html["コネクタをオンプレミスにインストールする"^]




=== コネクタのネットワーク要件

* コネクタが取り付けられているネットワークで次の接続が有効になっていることを確認します。
+
** クラウド階層化サービスへのポート443（HTTPS）経由のアウトバウンドインターネット接続
** S3 オブジェクトストレージへのポート 443 経由の HTTPS 接続 (https://docs.netapp.com/us-en/cloud-manager-setup-admin/reference-checklist-cm.html["エンドポイントのリストを参照してください"^])
** ONTAP クラスタ管理 LIF へのポート 443 経由の HTTPS 接続


* https://docs.netapp.com/us-en/cloud-manager-setup-admin/reference-permissions-aws.html#cloud-tiering["コネクタにS3バケットを管理する権限があることを確認します"^]
* ONTAP クラスタからVPCへのDirect ConnectまたはVPN接続が確立されている状況で、コネクタとS3の間の通信をAWS内部ネットワーク（*プライベート*接続）のままにする場合は、S3へのVPCエンドポイントインターフェイスを有効にする必要があります。  your system for a private connection using a VPC endpoint interface,VPC エンドポイントインターフェイスの設定方法を参照してください。




== ONTAP クラスタを準備

データを Amazon S3 に階層化するときは、 ONTAP クラスタが次の要件を満たしている必要があります。



=== ONTAP の要件

サポートされている ONTAP プラットフォーム::
+
--
* ONTAP 9.8 以降： FAS システム、またはオール SSD アグリゲートまたはオール HDD アグリゲートを使用する AFF システムからデータを階層化できます。
* ONTAP 9.7 以前を使用している場合： AFF システムまたはオール SSD アグリゲートを使用する FAS システムからデータを階層化できます。


--
サポートされている ONTAP のバージョン::
+
--
* ONTAP 9.2 以降
* オブジェクトストレージへのAWS PrivateLink接続を使用する場合、ONTAP 9.7以降が必要です


--
サポートされるボリュームとアグリゲート:: クラウド階層化が可能なボリュームの総数は、 ONTAP システムのボリュームの数よりも少なくなる可能性があります。これは、一部のアグリゲートからボリュームを階層化できないためです。については、 ONTAP のドキュメントを参照してください https://docs.netapp.com/us-en/ontap/fabricpool/requirements-concept.html#functionality-or-features-not-supported-by-fabricpool["FabricPool でサポートされていない機能"^]。



NOTE: Cloud Tiering は、 ONTAP 9.5 以降で FlexGroup ボリュームをサポートしています。セットアップは他のボリュームと同じように機能します。

必須のアプリケーションアクセスパラメータ:: クラスタ管理者ユーザは、「console」アプリケーションアクセス権を持っている必要があります。これは、ONTAP コマンドのsecurity login showを使用して確認できます。「admin」ユーザの_Application_Columnに「console」が表示されます。必要に応じて'security login createコマンドを使用してコンソール・アプリケーション・アクセスを追加します https://docs.netapp.com/us-en/ontap-cli-9111/security-login-create.html["詳細については、「security login」コマンドを参照してください"]。




=== クラスタネットワークの要件

* クラスタには、コネクタからクラスタ管理 LIF へのインバウンド HTTPS 接続が必要です。
+
クラスタと Cloud Tiering Service の間の接続は必要ありません。

* 階層化するボリュームをホストする各 ONTAP ノードにクラスタ間 LIF が 1 つ必要です。これらのクラスタ間 LIF がオブジェクトストアにアクセスできる必要があります。
+
階層化処理のために、クラスタ間LIFからAmazon S3ストレージへのポート443経由のアウトバウンドHTTPS接続が開始されます。ONTAP は、オブジェクトストレージとの間でデータの読み取りと書き込みを行います。オブジェクトストレージが開始されることはなく、応答するだけです。

* クラスタ間 LIF は、 ONTAP がオブジェクトストレージへの接続に使用する IPspace に関連付けられている必要があります。 https://docs.netapp.com/us-en/ontap/networking/standard_properties_of_ipspaces.html["IPspace の詳細については、こちらをご覧ください"^]。
+
Cloud Tieringをセットアップすると、IPspaceで使用するように求められます。これらの LIF が関連付けられている IPspace を選択します。これは、「デフォルト」の IPspace または作成したカスタム IPspace です。

+
「 default 」以外の IPspace を使用する場合は、オブジェクトストレージへのアクセスを取得するために静的ルートの作成が必要になることがあります。

+
IPspace内のすべてのクラスタ間LIFがオブジェクトストアにアクセスできる必要があります。現在のIPspaceに対してこれを設定できない場合は、すべてのクラスタ間LIFがオブジェクトストアにアクセスできる専用のIPspaceを作成する必要があります。

* AWSでS3接続にプライベートVPCインターフェイスエンドポイントを使用している場合は、HTTPS / 443を使用するために、S3エンドポイント証明書をONTAP クラスタにロードする必要があります。  your system for a private connection using a VPC endpoint interface,VPC エンドポイントインターフェイスのセットアップ方法を参照して、 S3 証明書をロードしてください。
*  up S3 permissions,ONTAP クラスタにS3バケットへのアクセス権限があることを確認します。




=== Cloud Manager で ONTAP クラスタを検出

コールドデータをオブジェクトストレージに階層化する前に、Cloud ManagerでオンプレミスのONTAP クラスタを検出する必要があります。クラスタを追加するには、クラスタ管理 IP アドレスと admin ユーザアカウントのパスワードが必要です。

https://docs.netapp.com/us-en/cloud-manager-ontap-onprem/task-discovering-ontap.html["クラスタの検出方法について説明します"^]。



== AWS 環境を準備

新しいクラスタにデータ階層化を設定するときは、 S3 バケットを作成するか、コネクタが設定されている AWS アカウントで既存の S3 バケットを選択するように求められます。AWS アカウントには、 Cloud Tiering で入力できる権限とアクセスキーが必要です。ONTAP クラスタは、アクセスキーを使用して S3 との間でデータを階層化します。

S3 バケットはに配置する必要があります link:reference-aws-support.html#supported-aws-regions["Cloud Tiering をサポートするリージョン"]。


NOTE: 階層化データが一定の日数後にに移行する低コストのストレージクラスを使用するように Cloud Tiering を設定する場合、 AWS アカウントでバケットのセットアップ時にライフサイクルルールを選択しないでください。Cloud Tiering は、ライフサイクルの移行を管理します。



=== S3 権限をセットアップする

次の 2 つの権限セットを設定する必要があります。

* S3バケットの作成と管理を行うコネクタの権限。
* オンプレミスの ONTAP クラスタの権限。 S3 バケットに対してデータの読み取りと書き込みを行うことができます。


.手順
. 確認します https://docs.netapp.com/us-en/cloud-manager-setup-admin/reference-permissions-aws.html#cloud-tiering["指定したS3権限になります"^] IAMロールの一部であり、コネクタに権限を付与します。これらは、コネクタを最初に展開したときにデフォルトで含まれています。そうでない場合は、不足している権限を追加する必要があります。を参照してください https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_manage-edit.html["AWS のドキュメント：「 Editing IAM policies"^]。
. サービスをアクティブ化すると、階層化ウィザードにアクセスキーとシークレットキーの入力を求められます。これらのクレデンシャルは、ONTAP がS3バケットにデータを階層化できるようにONTAP クラスタに渡されます。そのためには、次の権限を持つ IAM ユーザを作成する必要があります。
+
[source, json]
----
"s3:ListAllMyBuckets",
"s3:ListBucket",
"s3:GetBucketLocation",
"s3:GetObject",
"s3:PutObject",
"s3:DeleteObject"
----
+
を参照してください https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user.html["AWS ドキュメント：「 Creating a Role to Delegate Permissions to an IAM User"^] を参照してください。

. アクセスキーを作成または検索します。
+
クラウド階層化は、 ONTAP クラスタにアクセスキーを渡します。クレデンシャルはクラウド階層化サービスに保存されません。

+
https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html["AWS ドキュメント：「 Managing Access Keys for IAM Users"^]





=== VPCエンドポイントインターフェイスを使用して、システムにプライベート接続を設定します

標準のパブリックインターネット接続を使用する場合は、すべてのアクセス権がコネクタによって設定され、他に必要な操作はありません。このタイプの接続がに表示されます  diagrams for connection options,上の最初の図。

オンプレミスのデータセンターからVPCへのインターネット接続をよりセキュアにする場合は、階層化アクティブ化ウィザードでAWS PrivateLink接続を選択できます。VPNまたはAWS Direct Connectを使用して、プライベートIPアドレスを使用するVPCエンドポイントインターフェイス経由でオンプレミスシステムに接続する場合は、この環境が必要です。このタイプの接続がに表示されます  diagrams for connection options,上の2番目の図。

. Amazon VPC コンソールまたはコマンドラインを使用して、インターフェイスエンドポイント設定を作成します。 https://docs.aws.amazon.com/AmazonS3/latest/userguide/privatelink-interface-endpoints.html["AWS PrivateLink for Amazon S3 の使用に関する詳細を参照してください"^]。
. Cloud Manager Connector に関連付けられているセキュリティグループの設定を変更します。このポリシーを「 Custom 」（「 Full Access 」から）に変更する必要があります。また、変更する必要があります  up S3 permissions,必要なS3 Connector権限を追加します 前に示したように、
+
image:screenshot_tiering_aws_sec_group.png["コネクタに関連付けられている AWS セキュリティグループのスクリーンショット。"]

+
プライベートエンドポイントとの通信にポート80（HTTP）を使用している場合は、すべて設定されています。クラスタでCloud Tieringを有効にできます。

+
ポート443（HTTPS）を使用してプライベートエンドポイントと通信する場合は、VPC S3エンドポイントから証明書をコピーし、次の4つの手順でONTAP クラスタに追加する必要があります。

. AWS コンソールからエンドポイントの DNS 名を取得します。
+
image:screenshot_endpoint_dns_aws_console.png["AWS コンソールから VPC エンドポイントの DNS 名のスクリーンショット。"]

. VPC S3 エンドポイントから証明書を取得します。これは、で行います https://docs.netapp.com/us-en/cloud-manager-setup-admin/task-managing-connectors.html#connect-to-the-linux-vm["Cloud Manager Connector をホストする VM にログインします"^] 実行するコマンドエンドポイントの DNS 名を入力するときは、先頭に「 * 」を追加して、「 * 」を置き換えます。
+
[source, text]
----
[ec2-user@ip-10-160-4-68 ~]$ openssl s_client -connect bucket.vpce-0ff5c15df7e00fbab-yxs7lt8v.s3.us-west-2.vpce.amazonaws.com:443 -showcerts
----
. このコマンドの出力から、 S3 証明書のデータ（ BEGIN / END CERTIFICATE タグを含む、との間のすべてのデータ）をコピーします。
+
[source, text]
----
Certificate chain
0 s:/CN=s3.us-west-2.amazonaws.com`
   i:/C=US/O=Amazon/OU=Server CA 1B/CN=Amazon
-----BEGIN CERTIFICATE-----
MIIM6zCCC9OgAwIBAgIQA7MGJ4FaDBR8uL0KR3oltTANBgkqhkiG9w0BAQsFADBG
…
…
GqvbOz/oO2NWLLFCqI+xmkLcMiPrZy+/6Af+HH2mLCM4EsI2b+IpBmPkriWnnxo=
-----END CERTIFICATE-----
----
. ONTAP クラスタの CLI にログインし、次のコマンドを使用してコピーした証明書を適用します（代わりに独自の Storage VM 名を指定します）。
+
[source, text]
----
cluster1::> security certificate install -vserver <svm_name> -type server-ca
Please enter Certificate: Press <Enter> when done
----




== 最初のクラスタからAmazon S3にアクセス頻度の低いデータを階層化します

AWS 環境を準備したら、最初のクラスタからアクセス頻度の低いデータの階層化を開始します。

.必要なもの
* https://docs.netapp.com/us-en/cloud-manager-ontap-onprem/task-discovering-ontap.html["オンプレミスの作業環境"^]。
* 必要な S3 権限を持つ IAM ユーザの AWS アクセスキー。


.手順
. オンプレミスクラスタを選択
. 階層化サービスの * 有効化 * をクリックします。
+
Amazon S3階層化のデスティネーションがキャンバスに作業環境として存在する場合は、クラスタを作業環境にドラッグしてセットアップウィザードを開始できます。

+
image:screenshot_setup_tiering_onprem.png["オンプレミス ONTAP 作業環境を選択した後に画面の右側に表示される [ 有効 ] オプションを示すスクリーンショット。"]

. *オブジェクトストレージ名の定義*：このオブジェクトストレージの名前を入力します。このクラスタのアグリゲートで使用する可能性のある他のオブジェクトストレージから一意である必要があります。
. *プロバイダを選択*：「* Amazon Web Services *」を選択し、*続行*をクリックします。
+
image:screenshot_tiering_aws_s3_bucket.png["S3バケットへの階層化を設定するために指定が必要なデータを示すスクリーンショット。"]

. Create Object Storage *ページの次のセクションを実行します。
+
.. * S3 Bucket *：新しいS3バケットを追加するか、prefix_fabric-pool_で始まる既存のS3バケットを選択し、バケットのリージョンを選択して* Continue *をクリックします。
+
オンプレミスコネクタを使用する場合は、作成する既存の S3 バケットまたは新しい S3 バケットへのアクセスを提供する AWS アカウント ID を入力する必要があります。

+
コネクタの IAM ポリシーではインスタンスが指定したプレフィックスのバケットに対して S3 処理を実行できるため、 _fabric-pool_prefix が必要です。たとえば、 S3 バケット _fabric-pool-AFF1_、 AFF1 はクラスタの名前です。

.. *ストレージクラス*：Cloud Tieringは、階層化されたデータのライフサイクル移行を管理します。データは _Standard_class から始まりますが、データを特定の日数後に別のクラスに移動するルールを作成できます。
+
階層化データの移行先となる S3 ストレージクラスと、データを移動するまでの日数を選択し、 * Continue * をクリックします。たとえば、次のスクリーンショットは、オブジェクトストレージで 45 日後に階層化データが _Standard_class から _Standard-IA_class に移動されたことを示しています。

+
「 * このストレージクラスにデータを保持する」を選択した場合、データは _Standard_storage クラスに残り、ルールは適用されません。 link:reference-aws-support.html["「サポートされているストレージクラス」を参照"^]。

+
image:screenshot_tiering_lifecycle_selection_aws.png["特定の日数が経過したあとにデータを移動する別のストレージクラスの選択方法を示すスクリーンショット。"]

+
ライフサイクルルールは、選択したバケット内のすべてのオブジェクトに適用されます。

.. * クレデンシャル * ：必要な S3 権限を持つ IAM ユーザのアクセスキー ID とシークレットキーを入力し、 * Continue * をクリックします。
+
IAM ユーザは、「 * S3 Bucket * 」ページで選択または作成したバケットと同じ AWS アカウントに属している必要があります。

.. *ネットワーク*:ネットワークの詳細を入力し、[*続行]をクリックします。
+
階層化するボリュームが配置されているONTAP クラスタ内のIPspaceを選択します。このIPspaceのクラスタ間LIFは、クラウドプロバイダのオブジェクトストレージに接続できるように、アウトバウンドのインターネットアクセスを備えている必要があります。

+
必要に応じて、以前に設定した AWS PrivateLink を使用するかどうかを選択します。  your system for a private connection using a VPC endpoint interface,上記のセットアップ情報を参照してください。

+
エンドポイントの設定手順を説明するダイアログボックスが表示されます。



. _Tier Volume_page で、階層化を設定するボリュームを選択し、階層化ポリシーページを起動します。
+
** すべてのボリュームを選択するには、タイトル行（image:button_backup_all_volumes.png[""]）をクリックし、 * ボリュームの設定 * をクリックします。
** 複数のボリュームを選択するには、各ボリュームのボックス（image:button_backup_1_volume.png[""]）をクリックし、 * ボリュームの設定 * をクリックします。
** 単一のボリュームを選択するには、行（または）をクリックします image:screenshot_edit_icon.gif["鉛筆アイコンを編集します"] アイコン）をクリックします。
+
image:screenshot_tiering_tier_volumes.png["単一のボリューム、複数のボリューム、またはすべてのボリュームを選択する方法、および選択したボリュームを変更するボタンを示すスクリーンショット。"]



. _Tiering Policy_Dialog で、階層化ポリシーを選択し、必要に応じて選択したボリュームのクーリング日数を調整して、 * 適用 * をクリックします。
+
link:concept-cloud-tiering.html#volume-tiering-policies["ボリューム階層化ポリシーとクーリング期間の詳細を確認できます"]。

+
image:screenshot_tiering_policy_settings.png["設定可能な階層化ポリシーの設定を示すスクリーンショット。"]



これで、クラスタのボリュームから S3 オブジェクトストレージへのデータ階層化が設定されました。

link:task-licensing-cloud-tiering.html["Cloud Tiering サービスに登録してください"]。

クラスタ上のアクティブなデータとアクセス頻度の低いデータに関する情報を確認できます。 link:task-managing-tiering.html["階層化設定の管理について詳しくは、こちらをご覧ください"]。

また、クラスタの特定のアグリゲートのデータを別のオブジェクトストアに階層化したい場合に、追加のオブジェクトストレージを作成することもできます。または、階層化データが別のオブジェクトストアにレプリケートされているFabricPool ミラーリングを使用する予定の場合も同様です。 link:task-managing-object-storage.html["オブジェクトストアの管理に関する詳細情報"]。
